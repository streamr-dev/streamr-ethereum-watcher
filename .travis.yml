language: node_js
node_js:
- '14'
sudo: required
services:
- docker
branches:
  only:
  - master
  - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"
import:
 - source: streamr-dev/travis-ci:docker-secrets.yml@master
env:
  global:
  - OWNER=streamr
  - IMAGE_NAME=ethereum-watcher
jobs:
  include:
  - stage: Lint & unit tests
    script:
    - npm run lint
    - npm run test
  - stage: Build docker (Dev/Nightly)
    if: tag IS blank
    install: true
    script:
    - docker build -t $OWNER/$IMAGE_NAME:local .
    - .travis_scripts/smoke_test.sh
    deploy:
    - provider: script
      script: bash .travis_scripts/deploy_docker.sh dev
  - stage: Build docker (Production)
    if: tag IS present
    install: true
    script:
    - docker build -t $OWNER/$IMAGE_NAME:local .
    - .travis_scripts/smoke_test.sh
    deploy:
    - provider: script
      script: bash .travis_scripts/deploy_docker.sh production
      on:
        tags: true
notifications:
  slack:
    secure: jNjoKgPrEuxoA29nI+9n3CQyimOikMeRhhgvXOf0gNzn80CA8TrSWdTVtD4aAsXeuSGVfPMXd1m+25gZjAdOwP+eK+9rF7y8y0qqhanBr2xYiJqA5u6chILJG9rJZwSFQC/07QIQM8a8d8+olXmFWSesZwkf+SBrDopRkCBX+fRZB4tRZL/Y2laJYuFMpHRBzFiyLRsS8UjeEg3l29VLqfLY6FP7G0uh54yW7gr/Pmbcv67HfNq9y81DacqhNWx/cGWI0zHhgcSBHHGYOA6vGxJFAVR0kDMz19VXZBpQRBWjPA0SvJVX1hknoQewVqR0MSk8aJbdxaYMLg24Vh5Mj8ayvCfb4uiluS5IKQfGXqCM9RyzR3m2QVTekpyf1zOMijTo12RrfuBFE3DpjOyfp4Kfm4XxK7qdsAhSmoCgBF5+Vy08+nMiWBY9qT1Pry2mgfUtFX2wAVqNIr+kXO9eYkduOb5Q/hwObXOmyb7YLZHm46x6bfvfMnfM3wktj3OCO3NBs5hjQ0ExH63jfBP4lsN1TxT1MrhscfYLWPS3NIilL0ttVbSj8OklAYqw7et1hFdyqxXUUH3/EoGBk7XMPVHz57iClNVDW+bbalBAHn7xkezTLNgPFsrYG1s+/CYKUBy4+xnlLL8ow0G+8S3dRD3tEXfVeX2xUrfg8OY8yXU=
  on_success: change
  on_failure: always
  on_pull_requests: false
